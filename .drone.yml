---
kind: pipeline
name: audit modules

platform:
  os: linux
  arch: amd64

steps:
- name: install node:lts
  image: node:lts
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: audit all
  image: node:lts
  commands:
  - yarn run audit

---
kind: pipeline
name: lint modules

platform:
  os: linux
  arch: amd64

steps:
- name: install node:lts
  image: node:lts
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: lint all
  image: node:lts
  commands:
  - yarn run lint

---
kind: pipeline
name: size and timing

platform:
  os: linux
  arch: amd64

steps:
- name: slow-deps
  image: node:lts
  commands:
  - yarn global add slow-deps
  - slow-deps

---
kind: pipeline
name: "@bitgo/core node:6"

platform:
  os: linux
  arch: amd64

steps:
- name: install node:6
  image: node:6
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: unit tests node:6
  image: node:6
  commands:
  - yarn run lerna-run --scope bitgo --stream unit-test
  environment:
    BITGOJS_TEST_PASSWORD:
      from_secret: password

- name: upload coverage node:6
  image: node:6
  commands:
  - yarn global add codecov
  - yarn run lerna-run --scope bitgo gen-coverage
  - yarn run lerna-run --scope bitgo upload-coverage -- -F unit
  environment:
    CODECOV_TOKEN:
      from_secret: codecov

---
kind: pipeline
name: "@bitgo/core node:8"

platform:
  os: linux
  arch: amd64

steps:
- name: install node:8
  image: node:8
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: unit tests node:8
  image: node:8
  commands:
  - yarn run lerna-run --scope bitgo --stream unit-test
  environment:
    BITGOJS_TEST_PASSWORD:
      from_secret: password

- name: upload coverage node:8
  image: node:8
  commands:
  - yarn global add codecov
  - yarn run lerna-run --scope bitgo gen-coverage
  - yarn run lerna-run --scope bitgo upload-coverage -- -F unit
  environment:
    CODECOV_TOKEN:
      from_secret: codecov

---
kind: pipeline
name: "@bitgo/core node:10"

platform:
  os: linux
  arch: amd64

steps:
- name: install node:10
  image: node:10
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: unit tests node:10
  image: node:10
  commands:
  - yarn run lerna-run --scope bitgo --stream unit-test
  environment:
    BITGOJS_TEST_PASSWORD:
      from_secret: password

- name: upload coverage node:10
  image: node:10
  commands:
  - yarn global add codecov
  - yarn run lerna-run --scope bitgo gen-coverage
  - yarn run lerna-run --scope bitgo upload-coverage -- -F unit
  environment:
    CODECOV_TOKEN:
      from_secret: codecov

---
kind: pipeline
name: "@bitgo/core node:11"

platform:
  os: linux
  arch: amd64

steps:
- name: install node:11
  image: node:11
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: unit tests node:11
  image: node:11
  commands:
  - yarn run lerna-run --scope bitgo --stream unit-test
  environment:
    BITGOJS_TEST_PASSWORD:
      from_secret: password

- name: upload coverage node:11
  image: node:11
  commands:
  - yarn global add codecov
  - yarn run lerna-run --scope bitgo gen-coverage
  - yarn run lerna-run --scope bitgo upload-coverage -- -F unit
  environment:
    CODECOV_TOKEN:
      from_secret: codecov

---
kind: pipeline
name: "@bitgo/core node:lts"

platform:
  os: linux
  arch: amd64

steps:
- name: install node:lts
  image: node:lts
  commands:
  - node --version
  - npm --version
  - yarn --version
  - yarn install
  - yarn run bootstrap

- name: integration tests node:lts
  image: node:lts
  commands:
  - yarn run lerna-run --scope bitgo --stream integration-test
  environment:
    BITGOJS_TEST_PASSWORD:
      from_secret: password
  when:
    branch:
    - master
    - "rel/*"
    - prod/production

- name: upload coverage node:lts
  image: node:lts
  commands:
  - yarn global add codecov
  - yarn run lerna-run --scope bitgo gen-coverage
  - yarn run lerna-run --scope bitgo upload-coverage -- -F integration
  environment:
    CODECOV_TOKEN:
      from_secret: codecov
  when:
    branch:
    - master
    - "rel/*"
    - prod/production

...
