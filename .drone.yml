- kind: pipeline
  name: check preconditions (node:12)
  steps:
  - commands:
    - node --version
    - npm --version
    - yarn --version
    - git --version
    image: node:12
    name: build information
  - commands:
    - git fetch origin +refs/heads/$DRONE_REPO_BRANCH:$DRONE_REPO_BRANCH || true
    - yarn install --with-frozen-lockfile
    image: node:12
    name: install
  - commands:
    - yarn run check-commits
    image: node:12
    name: check-commits
  - commands:
    - yarn run check-versions
    image: node:12
    name: check-versions
  - commands:
    - yarn run audit
    image: node:12
    name: audit
  - commands:
    - yarn run lint
    image: node:12
    name: lint
  - commands:
    - yarn run check-fmt
    image: node:12
    name: check-fmt
  - commands:
    - yarn run gen-docs
    image: bitgosdk/upload-tools:latest
    name: generate docs
    when:
      event:
      - tag
      status:
      - success
  - commands:
    - yarn run upload-docs
    environment:
      reports_s3_akid:
        from_secret: reports_s3_akid
      reports_s3_sak:
        from_secret: reports_s3_sak
    image: bitgosdk/upload-tools:latest
    name: upload docs
    when:
      event:
      - tag
      status:
      - success
- kind: pipeline
  name: size and timing (node:12)
  steps:
  - commands:
    - npm install -g slow-deps
    - slow-deps
    image: node:12
    name: slow-deps
  trigger:
    branch:
      include:
      - master
      - rel/*
      - prod/production
- kind: pipeline
  name: unit tests (node:12)
  steps:
  - commands:
    - node --version
    - npm --version
    - yarn --version
    - git --version
    image: node:12
    name: build information
  - commands:
    - git fetch origin +refs/heads/$DRONE_REPO_BRANCH:$DRONE_REPO_BRANCH || true
    - yarn install --with-frozen-lockfile
    image: node:12
    name: install
  - commands:
    - yarn run unit-test-changed
    environment:
      BITGOJS_TEST_PASSWORD:
        from_secret: password
    image: node:12
    name: unit-test-changed
  - commands:
    - yarn run artifacts
    - yarn run gen-coverage-changed
    - yarn run coverage
    environment:
      CODECOV_FLAG: unit
      CODECOV_TOKEN:
        from_secret: codecov
      reports_s3_akid:
        from_secret: reports_s3_akid
      reports_s3_sak:
        from_secret: reports_s3_sak
    image: bitgosdk/upload-tools:latest
    name: upload artifacts
    when:
      status:
      - success
      - failure
- kind: pipeline
  name: unit tests (node:14)
  steps:
  - commands:
    - node --version
    - npm --version
    - yarn --version
    - git --version
    image: node:14
    name: build information
  - commands:
    - git fetch origin +refs/heads/$DRONE_REPO_BRANCH:$DRONE_REPO_BRANCH || true
    - yarn install --with-frozen-lockfile
    image: node:14
    name: install
  - commands:
    - yarn run unit-test-changed
    environment:
      BITGOJS_TEST_PASSWORD:
        from_secret: password
    image: node:14
    name: unit-test-changed
  - commands:
    - yarn run artifacts
    - yarn run gen-coverage-changed
    - yarn run coverage
    environment:
      CODECOV_FLAG: unit
      CODECOV_TOKEN:
        from_secret: codecov
      reports_s3_akid:
        from_secret: reports_s3_akid
      reports_s3_sak:
        from_secret: reports_s3_sak
    image: bitgosdk/upload-tools:latest
    name: upload artifacts
    when:
      status:
      - success
      - failure
- kind: pipeline
  name: unit tests (node:15)
  steps:
  - commands:
    - node --version
    - npm --version
    - yarn --version
    - git --version
    image: node:15
    name: build information
  - commands:
    - git fetch origin +refs/heads/$DRONE_REPO_BRANCH:$DRONE_REPO_BRANCH || true
    - yarn install --with-frozen-lockfile
    failure: ignore
    image: node:15
    name: install
  - commands:
    - yarn run unit-test-changed
    environment:
      BITGOJS_TEST_PASSWORD:
        from_secret: password
    failure: ignore
    image: node:15
    name: unit-test-changed
  - commands:
    - yarn run artifacts
    - yarn run gen-coverage-changed
    - yarn run coverage
    environment:
      CODECOV_FLAG: unit
      CODECOV_TOKEN:
        from_secret: codecov
      reports_s3_akid:
        from_secret: reports_s3_akid
      reports_s3_sak:
        from_secret: reports_s3_sak
    failure: ignore
    image: bitgosdk/upload-tools:latest
    name: upload artifacts
    when:
      status:
      - success
      - failure
- kind: pipeline
  name: Browser Tests
  steps:
  - commands:
    - node --version
    - npm --version
    - yarn --version
    - git --version
    image: node:12
    name: build information
  - commands:
    - git fetch origin +refs/heads/$DRONE_REPO_BRANCH:$DRONE_REPO_BRANCH || true
    - yarn install --with-frozen-lockfile
    image: node:12
    name: install
  - commands:
    - apt-get update
    - apt-get install -y gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 libc6
      libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4
      libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0
      libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1
      libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates
      fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
    - yarn run browser-tests
    environment:
      BITGOJS_TEST_PASSWORD:
        from_secret: password
    image: node:12
    name: browser-tests
  - commands:
    - yarn run artifacts
    - yarn run gen-coverage-changed
    - yarn run coverage
    environment:
      CODECOV_FLAG: unit
      CODECOV_TOKEN:
        from_secret: codecov
      reports_s3_akid:
        from_secret: reports_s3_akid
      reports_s3_sak:
        from_secret: reports_s3_sak
    image: bitgosdk/upload-tools:latest
    name: upload artifacts
    when:
      status:
      - success
      - failure
  trigger:
    branch:
      include:
      - master
      - rel/*
      - prod/production
